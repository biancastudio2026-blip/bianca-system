<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bianca_eye.studio ç®¡ç†ç³»çµ± (V49 å–®å“æŠ˜æ‰£ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒ CSS --- */
        :root { --bg-color: #Fdfbfb; --main-pink: #EAC8D0; --dark-pink: #C79AA5; --text-color: #6D6063; --card-bg: #FFFFFF; --shadow: 4px 4px 0px #EAC8D0; --danger-color: #CD5C5C; --success-color: #2E8B57; --highlight-color: #FF69B4; --blue-color: #4682B4; --expense-color: #8B4513; }
        body { font-family: 'Gaegu', "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: var(--bg-color); background-image: radial-gradient(#EAC8D0 1px, transparent 1px); background-size: 20px 20px; color: var(--text-color); margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; } ::-webkit-scrollbar-thumb { background: var(--dark-pink); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #a86e7b; }
        button { font-family: inherit; cursor: pointer; border: 2px solid var(--text-color); transition: 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 2px 2px 0 var(--text-color); }
        input, select, textarea { border: 2px solid var(--main-pink); border-radius: 8px; padding: 5px; font-family: inherit; outline: none; color: var(--text-color); }
        
        /* ç™»å…¥ç•«é¢ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #Fdfbfb; background-image: radial-gradient(#EAC8D0 1px, transparent 1px); background-size: 20px 20px; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; border: 3px solid var(--text-color); box-shadow: 8px 8px 0 var(--main-pink); text-align: center; width: 300px; }
        .login-input { width: 100%; padding: 10px; margin-bottom: 15px; box-sizing: border-box; font-size: 1.1rem; }
        .login-btn { background: var(--dark-pink); color: white; padding: 10px 30px; border-radius: 10px; font-size: 1.2rem; width: 100%; }
        .login-error { color: var(--danger-color); margin-top: 10px; font-weight: bold; display: none; }

        /* ä¸»é¸å–® */
        #dashboard-view { display: none; width: 100%; height: 100%; justify-content: center; align-items: center; gap: 40px; flex-direction: column; }
        .dashboard-title { font-size: 3rem; font-weight: bold; color: var(--dark-pink); margin-bottom: 20px; text-shadow: 2px 2px 0 #fff; }
        .menu-container { display: flex; gap: 30px; }
        .menu-card { width: 220px; height: 220px; background: white; border: 3px solid var(--text-color); border-radius: 20px; box-shadow: 8px 8px 0 var(--main-pink); display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; color: var(--text-color); cursor: pointer; transition: 0.3s; }
        .menu-card:hover { transform: scale(1.05) translateY(-5px); box-shadow: 12px 12px 0 var(--dark-pink); background: #FFF0F5; }
        .menu-icon { font-size: 4rem; margin-bottom: 15px; }
        .logout-btn-dash { position: absolute; top: 20px; right: 20px; background: white; color: var(--danger-color); padding: 5px 15px; border-radius: 10px; font-size: 1rem; cursor: pointer; z-index: 100;}

        /* POS çµå¸³ç³»çµ± */
        #pos-view { display: none; width: 100%; height: 100%; padding: 20px; box-sizing: border-box; gap: 20px; }
        .pos-left { flex: 6; background: white; border: 2px solid var(--text-color); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; box-shadow: var(--shadow); overflow-y: auto; }
        .pos-right { flex: 4; background: #FFF0F5; border: 2px solid var(--text-color); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; box-shadow: var(--shadow); position: relative;}
        .pos-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; color: var(--dark-pink); display: flex; justify-content: space-between; align-items: center; }
        
        .category-section { margin-bottom: 25px; border-bottom: 2px dashed #eee; padding-bottom: 15px; }
        .category-title { font-size: 1.2rem; font-weight: bold; color: var(--text-color); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .items-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .item-btn { 
            background: white; border: 2px solid var(--main-pink); border-radius: 10px; padding: 10px; 
            width: 120px; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: 0.2s; text-align: center; cursor: pointer; font-size: 1rem;
        }
        .item-btn:hover { background: var(--main-pink); color: white; transform: scale(1.05); }
        .item-btn.special { border-style: dashed; background: #fafafa; }

        .cart-list { flex-grow: 1; overflow-y: auto; background: white; border: 2px solid var(--main-pink); border-radius: 10px; padding: 10px; margin-bottom: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed #eee; font-size: 1.1rem; cursor: pointer; border-left: 5px solid transparent; }
        /* V49: Highlight Selected Item */
        .cart-item.active-item { background-color: #FFF0F5; border-left: 5px solid var(--highlight-color); }
        
        .cart-remove { color: var(--danger-color); cursor: pointer; margin-left: 10px; font-weight: bold; }
        .auto-discount-tag { color: var(--highlight-color); font-size: 0.8rem; display: block; margin-top: 2px; font-weight: bold;}
        .first-time-badge { background: var(--highlight-color); color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.8rem; margin-left: 5px; }
        .receipt-time { font-size: 1.1rem; color: var(--text-color); text-align: right; margin-bottom: 5px; font-weight: bold; }

        /* é¤˜é¡èˆ‡æ”¯ä»˜å€å¡Š */
        .balance-display { background: #fff; border: 2px dashed var(--main-pink); padding: 10px; margin-bottom: 15px; border-radius: 10px; text-align: center; color: var(--text-color); font-size: 1.1rem; }
        .balance-amount { color: var(--success-color); font-weight: bold; font-size: 1.3rem; }
        .calc-area { background: white; padding: 15px; border-radius: 15px; border: 2px solid var(--text-color); }
        .total-row { display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: var(--dark-pink); }
        .split-pay-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 1.1rem; }
        .checkout-btn { background: var(--dark-pink); color: white; width: 100%; padding: 15px; font-size: 1.5rem; border-radius: 10px; border: 2px solid var(--text-color); margin-top: 10px; }
        .back-home-btn { background: #eee; padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; }

        /* å ±è¡¨ç³»çµ± */
        .full-view { display: none; width: 100%; height: 100%; gap: 20px; padding: 20px; box-sizing: border-box; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-table th, .report-table td { text-align: left; padding: 8px; border-bottom: 1px dashed var(--main-pink); font-size: 1.1rem; }
        .report-table th { background: #FFF0F5; color: var(--dark-pink); }
        .report-table tr.clickable:hover { background-color: #f0f0f0; } 
        .report-footer { margin-top: 20px; font-size: 1.5rem; font-weight: bold; text-align: right; color: var(--dark-pink); border-top: 2px solid var(--text-color); padding-top: 10px;}

        /* CRM å®¢æˆ¶ç®¡ç† */
        #crm-view { position: relative; } 
        .sidebar { 
            width: 250px; background: var(--card-bg); border: 2px solid var(--text-color); border-radius: 15px 255px 15px 25px / 255px 15px 225px 15px; padding: 20px; 
            box-shadow: var(--shadow); display: flex; flex-direction: column; height: 100%; box-sizing: border-box; 
            transition: all 0.3s ease; overflow: hidden; opacity: 1;
        }
        .sidebar.closed { width: 0; padding: 0; border: none; opacity: 0; margin-right: 0; }
        
        .toggle-side-btn {
            position: absolute; top: 10px; left: 10px; z-index: 100;
            background: var(--dark-pink); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;
        }

        .main-container { flex-grow: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .client-list { list-style: none; padding: 0; overflow-y: auto; flex-grow: 1; }
        .client-item { padding: 10px; border-bottom: 1px dashed var(--main-pink); cursor: pointer; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; white-space: nowrap;}
        .client-item.active { background-color: #FFF0F5; font-weight: bold; border-left: 5px solid var(--dark-pink); }
        .content-card { background: var(--card-bg); border: 2px solid var(--text-color); border-radius: 0 15px 15px 15px; box-shadow: var(--shadow); padding: 20px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 5; }
        
        .tabs-header { display: flex; gap: 5px; padding-left: 10px; margin-bottom: -2px; z-index: 10; }
        .tab-btn { background: #f0f0f0; border: 2px solid var(--text-color); border-bottom: none; padding: 8px 20px; font-size: 1.2rem; cursor: pointer; border-radius: 15px 15px 0 0; color: var(--text-color); position: relative; top: 2px; }
        .tab-btn.active { background: var(--card-bg); font-weight: bold; color: var(--dark-pink); top: 0; padding-bottom: 10px; box-shadow: 0 -2px 0 var(--main-pink) inset; }
        .tab-content { display: none; height: 100%; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        .scroll-container { overflow-y: auto; flex-grow: 1; padding-right: 10px; display: flex; flex-direction: column; gap: 20px; }
        
        .form-section { border: 2px solid var(--main-pink); border-radius: 15px; background: #fff; display: flex; flex-direction: column; height: auto; min-height: 200px; flex-shrink: 0; margin-bottom: 15px; }
        .form-header { background: var(--main-pink); color: white; padding: 10px 15px; font-size: 1.2rem; font-weight: bold; border-bottom: 2px solid var(--main-pink); flex-shrink: 0; }
        .form-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .form-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 12px; align-items: center; }
        .add-btn { background: var(--dark-pink); color: white; border: 2px solid var(--text-color); padding: 8px; border-radius: 10px; margin-bottom: 10px; text-align: center; }
        .delete-btn { background: var(--danger-color); color: white; border: none; border-radius: 5px; padding: 2px 8px; font-size: 0.8rem; margin-left: 10px; cursor: pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; border: 3px solid var(--text-color); width: 400px; box-shadow: 5px 5px 0 rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .close-btn { float: right; cursor: pointer; font-weight: bold; font-size: 1.2rem; }
        .btn-save { background: var(--dark-pink); width: 100%; font-size: 1.2rem; margin-top: 20px; color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer;}
        
        /* Others */
        .photos-container { display: flex; gap: 10px; margin-top: 10px; }
        .photo-column { flex: 1; background: #fff; padding: 10px; border-radius: 10px; border: 1px dashed var(--main-pink); }
        .photo-grid { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
        .photo-box { width: 60px; height: 60px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; background-size: cover; cursor: pointer; border-radius: 8px; }
        .photo-box.has-img { border: 2px solid var(--dark-pink); cursor: default; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .tag-chip { padding: 5px 15px; border: 2px solid var(--main-pink); border-radius: 20px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .tag-chip.active { background: var(--main-pink); color: white; border-color: var(--dark-pink); }
        .add-tag-wrapper { display: flex; gap: 5px; align-items: center; margin-top: 10px;}
        .agree-label { align-items: flex-start; line-height: 1.5; margin-bottom: 12px; display:flex; gap:5px;}
        .agree-label input { margin-top: 5px; flex-shrink: 0; }
        input[type="checkbox"] { transform: scale(1.2); accent-color: var(--dark-pink); }
        
        #signature-preview-box {
            border: 2px dashed var(--main-pink); border-radius: 10px; background: #fff; width: 100%; height: 100px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;
            overflow: hidden; transition: 0.2s;
        }
        #signature-preview-box:hover { background: #FFF0F5; border-color: var(--dark-pink); }
        #signature-preview-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        #signature-placeholder { color: var(--dark-pink); font-weight: bold; }
        #signature-pad { border: 2px dashed var(--text-color); border-radius: 10px; background: #fff; width: 100%; height: 150px; cursor: crosshair; touch-action: none; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px dashed var(--main-pink); }
        th { color: var(--dark-pink); background: #FFF0F5;}
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>Bianca<br>Eye Studio</h2>
            <div style="font-size: 0.9rem; margin-bottom: 15px; color: var(--dark-pink);">âœ¨ V49 å–®å“æŠ˜æ‰£ç‰ˆ</div>
            <input type="email" id="login_email" class="login-input" placeholder="Firebase Email">
            <input type="password" id="login_pwd" class="login-input" placeholder="å¯†ç¢¼">
            <button id="btnLogin" class="login-btn">ç™»å…¥ç³»çµ±</button>
            <div id="loginError" class="login-error"></div>
        </div>
    </div>

    <div id="dashboard-view">
        <button class="logout-btn-dash" id="btnLogout">ç™»å‡º</button>
        <div class="dashboard-title">âœ¨ è«‹é¸æ“‡ä½œæ¥­ç³»çµ±</div>
        <div class="menu-container">
            <div class="menu-card" onclick="window.goToPOS()">
                <div class="menu-icon">ğŸ›’</div><div>çµå¸³ä½œæ¥­</div>
            </div>
            <div class="menu-card" onclick="window.goToCRM()">
                <div class="menu-icon">ğŸ‘¥</div><div>å®¢æˆ¶ç®¡ç†</div>
            </div>
        </div>
        <div class="menu-container" style="margin-top: 20px;">
            <div class="menu-card" onclick="window.goToDaily()">
                <div class="menu-icon">ğŸŒ</div><div>æ—¥çµä½œæ¥­</div>
            </div>
            <div class="menu-card" onclick="window.goToMonthly()">
                <div class="menu-icon">ğŸŒ</div><div>æœˆçµä½œæ¥­</div>
            </div>
        </div>
    </div>

    <div id="pos-view">
        <div class="pos-left">
            <div class="pos-header">
                <span>ğŸ“¦ é …ç›®é¸æ“‡</span>
                <button class="back-home-btn" onclick="window.goToDashboard()">ğŸ  å›é¦–é </button>
            </div>
            
            <div class="category-section">
                <div class="category-title">ğŸ’… èª²ç¨‹</div>
                <div class="items-grid" id="pos_courses"></div>
                <div class="items-grid" style="margin-top:10px">
                    <div class="item-btn special" onclick="window.showTintModal()">æ¿ƒé»‘é¤Šè­·<br><small>é»æ“Šé¸æ“‡</small></div>
                </div>
            </div>

            <div class="category-section">
                <div class="category-title">ğŸ›ï¸ ç”¢å“</div>
                <div class="items-grid" id="pos_products"></div>
                
                <div class="category-title" style="margin-top:15px; color:#4682B4;">ğŸ’° å„²å€¼å°ˆå€</div>
                <div class="items-grid">
                    <div class="item-btn special" style="border-color:#4682B4;color:#4682B4; width:100%;" onclick="window.addTopUp()">å„²å€¼é‡‘<br><small>è‡ªè¨‚é‡‘é¡ (è³¼è²·é»æ•¸)</small></div>
                </div>
            </div>
            
            <div class="category-section" style="margin-top:15px;">
                <div class="category-title" style="color: var(--expense-color);">ğŸ’¸ æ”¯å‡º (è² é …)</div>
                <div class="items-grid">
                    <div class="item-btn special" style="border-color:var(--expense-color);color:var(--expense-color);" onclick="window.addExpense('è€—æ')">è€—æ<br><small>è¼¸å…¥é‡‘é¡</small></div>
                    <div class="item-btn special" style="border-color:var(--expense-color);color:var(--expense-color);" onclick="window.addExpense('é€€æ¬¾')">é€€æ¬¾<br><small>è¼¸å…¥é‡‘é¡</small></div>
                    <div class="item-btn special" style="border-color:var(--expense-color);color:var(--expense-color);" onclick="window.addExpense('è¨­å‚™')">è¨­å‚™<br><small>è¼¸å…¥é‡‘é¡</small></div>
                </div>
            </div>

            <div class="category-section" style="border-bottom:none;">
                <div class="category-title">ğŸ å„ªæƒ  / å…¶ä»–</div>
                <div class="items-grid">
                    <span id="pos_discounts" style="display:contents"></span>
                    <div class="item-btn special" style="border-color:#FF69B4;color:#FF69B4;" onclick="window.applySingleItemDiscount()">å–®å“æŠ˜æ‰£<br><small>é¸å–å•†å“å¾Œé»æ“Š</small></div>
                    <div class="item-btn special" style="border-color:var(--blue-color);color:var(--blue-color);" onclick="window.addModelPrice()">æ¨¡ç‰¹åƒ¹<br><small>è¼¸å…¥é‡‘é¡</small></div>
                </div>
            </div>
        </div>

        <div class="pos-right">
            <div class="pos-header">ğŸ§¾ çµå¸³æ¸…å–®</div>
            <div class="receipt-time" id="receiptTime">--/--/-- --:--</div>
            
            <div class="form-row">
                <input type="text" id="pos_client_name" list="client_list_suggestions" placeholder="è¼¸å…¥é¡§å®¢å§“åæœå°‹..." style="width: 100%;" oninput="window.checkPosClient(this.value)">
                <datalist id="client_list_suggestions"></datalist>
            </div>

            <div class="balance-display">
                å„²å€¼é‡‘é¤˜é¡ï¼š<span id="posBalance" class="balance-amount">-</span>
            </div>

            <div class="cart-list" id="cartList"><div style="text-align:center; color:#ccc; margin-top:50px;">å°šæœªé¸æ“‡é …ç›®</div></div>
            
            <div class="calc-area">
                <div class="total-row"><span>ç¸½é‡‘é¡ï¼š</span><span id="posTotal">$0</span></div>
                
                <div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;">
                    <div class="split-pay-row">
                        <label style="display:flex;align-items:center;cursor:pointer"><input type="checkbox" id="use_balance" onchange="window.updateCalculations()"> ä½¿ç”¨å„²å€¼é‡‘æ‰£æ¬¾</label>
                        <span id="deduct_display" style="color:var(--danger-color)">-$0</span>
                    </div>
                </div>

                <div class="split-pay-row"><span>å‰©é¤˜æ‡‰ä»˜ï¼š</span><span id="remain_display" style="font-weight:bold">$0</span></div>

                <div class="form-row" id="final_pay_method_row">
                    <label>é¤˜é¡æ”¯ä»˜ï¼š
                        <select id="pos_method" style="flex-grow:1;"><option>ç¾é‡‘</option><option>åŒ¯æ¬¾</option><option>å…¨æ”¯ä»˜</option></select>
                    </label>
                </div>
                <button class="checkout-btn" onclick="window.submitCheckout()">ğŸ’° ç¢ºèªçµå¸³</button>
            </div>
        </div>
    </div>

    <div id="daily-view" class="full-view">
        <div class="content-card">
            <div class="pos-header"><span>ğŸŒ æ—¥çµä½œæ¥­ (å³æ™‚åŒæ­¥)</span><button class="back-home-btn" onclick="window.goToDashboard()">ğŸ  å›é¦–é </button></div>
            <div style="font-size:1.2rem; margin-bottom:10px;">æ—¥æœŸï¼š<span id="dailyDate"></span></div>
            <div style="overflow-y:auto; flex-grow:1;">
                <table class="report-table">
                    <thead><tr><th>æ™‚é–“</th><th>å§“å</th><th>é …ç›®(åˆ†é¡)</th><th>é‡‘é¡</th><th>æ”¯ä»˜æ–¹å¼</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="dailyList"></tbody>
                </table>
            </div>
            <div class="report-footer">
                æœ¬æ—¥æ·¨æ”¶ï¼š<span id="dailyTotal">$0</span>
                <span id="lockMsg" style="display:none; color:red; font-size:1rem; margin-left:10px;">(å·²çµå¸³é–å®š)</span>
                <button id="closeDayBtn" class="btn-save" style="width:auto; margin-left:20px; font-size:1.2rem;" onclick="window.confirmDailyClose()">ğŸ“… åŸ·è¡Œç•¶æ—¥çµå¸³</button>
            </div>
        </div>
    </div>

    <div id="monthly-view" class="full-view">
        <div class="content-card">
            <div class="pos-header"><span>ğŸŒ æœˆçµä½œæ¥­ (é»æ“Šæ—¥æœŸæŸ¥çœ‹æ˜ç´°)</span><button class="back-home-btn" onclick="window.goToDashboard()">ğŸ  å›é¦–é </button></div>
            <div style="margin-bottom:10px;">æœˆä»½ï¼š<input type="month" id="monthlyPicker" onchange="window.renderMonthlyReport()"></div>
            <div style="overflow-y:auto; flex-grow:1;">
                <table class="report-table"><thead><tr><th>æ—¥æœŸ</th><th>å–®æ•¸</th><th>ç¸½é‡‘é¡</th><th>ç‹€æ…‹</th></tr></thead><tbody id="monthlyList"></tbody></table>
            </div>
            <div class="report-footer">æœ¬æœˆç¸½æ”¶ï¼š<span id="monthlyTotal">$0</span></div>
        </div>
    </div>

    <div id="crm-view" class="full-view">
        <button class="toggle-side-btn" onclick="window.toggleSidebar()">â˜°</button>
        
        <div class="sidebar" id="crmSidebar">
            <div style="text-align:center; margin-bottom:10px; margin-top:25px;"><button class="back-home-btn" onclick="window.goToDashboard()">ğŸ  å›é¦–é </button></div>
            <button class="add-btn" onclick="window.createNewClient()">+ æ–°å¢é¡§å®¢</button>
            
            <select id="regionFilter" style="width:100%; margin-bottom:5px;" onchange="window.renderClientList()">
                <option value="all">ğŸ“ æ‰€æœ‰åœ°å€</option>
                <option value="æ–°ç«¹">æ–°ç«¹</option>
                <option value="æ·¡æ°´">æ·¡æ°´</option>
            </select>

            <select id="monthFilter" style="width:100%; margin-bottom:10px;" onchange="window.renderClientList()">
                <option value="all">ğŸ“… æ‰€æœ‰å£½æ˜Ÿ</option><option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option><option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option><option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09">9æœˆ</option><option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
            </select>
            
            <ul class="client-list" id="clientList"></ul>
            <div id="clientTotalCount" style="text-align:center; font-weight:bold; margin-top:10px; color:var(--dark-pink);">ğŸ‘¥ åˆ—è¡¨äººæ•¸ï¼š0 äºº</div>
        </div>
        
        <div class="main-container" id="mainContainer">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="window.switchTab('profile', event)">ğŸ“‹ å€‹äººè³‡æ–™</button>
                <button class="tab-btn" onclick="window.switchTab('sessions', event)">ğŸ‘ï¸ èª²ç¨‹ç´€éŒ„</button>
                <button class="tab-btn" onclick="window.switchTab('billing', event)">ğŸ’° æ¶ˆè²»ç´€éŒ„</button>
                <button class="tab-btn" onclick="window.switchTab('notes', event)">ğŸ“ å‚™è¨» / æ¨™ç±¤</button>
            </div>
            <div class="content-card">
                <div id="profile" class="tab-content active">
                    <div class="scroll-container">
                        <div class="form-section"><div class="form-header">åŸºæœ¬è³‡æ–™</div><div class="form-body">
                            <div class="form-row"><label>å§“åï¼š<input type="text" id="p_name" oninput="window.debounceSaveProfile()"></label><label>é›»è©±ï¼š<input type="text" id="p_phone" oninput="window.debounceSaveProfile()"></label></div>
                            <div class="form-row">
                                <label>ç”Ÿæ—¥ï¼š<input type="date" id="p_birthday" onchange="window.saveProfile()"></label>
                                <label style="margin-left:10px;">åœ°å€ï¼š
                                    <select id="p_region" onchange="window.saveProfile()">
                                        <option value="">è«‹é¸æ“‡</option>
                                        <option value="æ–°ç«¹">æ–°ç«¹</option>
                                        <option value="æ·¡æ°´">æ·¡æ°´</option>
                                    </select>
                                </label>
                            </div>
                            <div class="form-row"><label style="align-self: flex-start; margin-top: 5px;">å¾å“ªèªè­˜ Biancaï¼š</label><div class="checkbox-group" style="display:flex; flex-direction:column; gap:5px;"><label><input type="checkbox" data-key="source_ig"> Instagram</label><label><input type="checkbox" data-key="source_threads"> Threads</label><label><input type="checkbox" data-key="source_fb"> Facebook</label><label><input type="checkbox" data-key="source_friend"> æœ‹å‹ä»‹ç´¹ <input type="text" class="inline-input" id="p_friend_name" placeholder="æœ‹å‹å§“å" oninput="window.debounceSaveProfile()"></label>
                            <label><input type="checkbox" data-key="source_neighbor"> ç¤¾å€é„°å±… <input type="text" class="inline-input" id="p_neighbor_unit" placeholder="æˆ¶è™Ÿ (å¦‚11F-3)" oninput="window.debounceSaveProfile()"></label>
                            </div></div>
                        </div></div>
                        <div class="form-section"><div class="form-header">çœ¼éƒ¨ç‹€æ³ & ç¿’æ…£</div><div class="form-body"><div class="form-row"><label>ç«æ¯›ç‹€æ³ï¼š</label><div class="checkbox-group"><label><input type="checkbox" data-key="lash_short"> çŸ­</label><label><input type="checkbox" data-key="lash_med"> ä¸­</label><label><input type="checkbox" data-key="lash_long"> é•·</label><label><input type="checkbox" data-key="lash_thick"> æ¿ƒ</label><label><input type="checkbox" data-key="lash_thin"> ç¨€ç–</label></div></div><div class="form-row"><label>çœ¼å‹ï¼š</label><div class="checkbox-group"><label><input type="checkbox" data-key="eye_size"> å¤§å°çœ¼</label><label><input type="checkbox" data-key="eye_single"> å–®çœ¼çš®</label><label><input type="checkbox" data-key="eye_inner"> å…§é›™</label><label><input type="checkbox" data-key="eye_double"> é›™çœ¼çš®</label><label><input type="checkbox" data-key="eye_puffy"> æ³¡æ³¡çœ¼</label><label><input type="checkbox" data-key="eye_down"> ç«æ¯›ä¸‹å‚</label><label><input type="checkbox" data-key="eye_inverse"> ç«æ¯›å€’æ’</label></div></div><div class="form-row"><label>çœ¼ç›ç–¾ç—…ï¼š<input type="text" id="p_disease" placeholder="ç„¡ / æœ‰ï¼Œè«‹èªªæ˜" oninput="window.debounceSaveProfile()"></label></div><div class="form-row"><label>æ˜¯å¦æ‡·å­•ï¼š<input type="checkbox" data-key="preg_no"> ç„¡ <input type="checkbox" data-key="preg_yes"> æœ‰</label></div><div class="form-row"><label>æ˜¯å¦éæ•ï¼š<input type="checkbox" data-key="allergy_no"> ç„¡ <input type="checkbox" data-key="allergy_dye"> æŸ“é«® <input type="checkbox" data-key="allergy_latex"> ä¹³è†  å…¶ä»– <input type="text" id="p_allergy_other" style="width:100px" oninput="window.debounceSaveProfile()"></label></div><div class="form-row"><label>æœ‰ç„¡æ“ä½œéï¼š<input type="text" id="p_exp" placeholder="ç„¡ / æœ‰ï¼Œå¤§ç´„å¹¾æ¬¡" oninput="window.debounceSaveProfile()"></label></div><div class="form-row"><label>ä¿é¤Šç¿’æ…£ï¼š<input type="text" id="p_habit" placeholder="ç„¡ / æœ‰ï¼Œä½¿ç”¨ç”¢å“" oninput="window.debounceSaveProfile()"></label></div><div class="form-row"><label>ä¸Šå¦ç¿’æ…£ï¼š<input type="checkbox" data-key="makeup_light"> æ·¡å¦ <input type="checkbox" data-key="makeup_heavy"> æ¿ƒå¦ <input type="checkbox" data-key="makeup_eye"> è‘—é‡çœ¼å¦</label></div></div></div>
                        <div class="form-section"><div class="form-header">åŒæ„æ›¸ & ç°½å</div><div class="form-body">
                            <label class="agree-label"><input type="checkbox" data-key="agree_1"> <span>æˆ‘çŸ¥é“æœ¬èº«æœ‰ä»»ä½•éæ•æˆ–çœ¼ç›ä¸é©ç¾è±¡ï¼Œæˆ‘å°‡äº‹å…ˆå‘ŠçŸ¥æœå‹™äººå“¡ï¼Œä¸¦äº†è§£ç”±æ–¼æ¯å€‹äººé«”è³ªä¸åŒï¼Œè‡ªçŸ¥æ‚‰åº—å®¶æœå‹™æ‰€ä½¿ç”¨ä¹‹ç”¢å“å‡ç¶“éåˆæ ¼èªè­‰ï¼Œä¸”æœå‹™äººå“¡å‡ç¶“éåˆæ ¼æŠ€è¡“é‘‘å®šï¼Œè‹¥å› å€‹äººé«”è³ªé—œä¿‚æˆ–è¡›ç”Ÿå•é¡Œç”¢ç”Ÿä¸é©ç¾è±¡ï¼Œæœå‹™åº—å®¶å¯äº«æœ‰å…è²¬æ¬Šã€‚</span></label>
                            <label class="agree-label"><input type="checkbox" data-key="agree_2"> <span>æˆ‘çŸ¥é“ç«æ¯›ç®¡ç†å¾Œï¼Œå› æ¯å€‹äººçš„ç¿’æ…£è·Ÿä¿é¤Šæ–¹å¼ä¸åŒï¼Œç«æ¯›ç”Ÿé•·é€Ÿåº¦ä¹Ÿä¸ç›¡ç›¸åŒï¼Œæ•…åº—å®¶ç„¡æ³•æä¾›ä»»ä½•çš„ä¿å›ºæœŸï¼Œå…¶ä»–å•é¡Œå¯ç›´æ¥èˆ‡åº—å®¶è¯ç¹«ï¼Œåº—å®¶å°‡èª å¿ƒå”åŠ©ã€‚</span></label>
                            <label class="agree-label"><input type="checkbox" data-key="agree_3"> <span>æˆ‘çŸ¥é“æ¯å€‹äººå®Œæˆå¾Œçš„æ„Ÿè¦ºä¸åŒï¼Œå–æ±ºæ–¼ç«æ¯›å…ˆå¤©æ¢ä»¶ã€‚</span></label>
                            <label class="agree-label" style="background:#FFF0F5; padding:5px; border-radius:5px;"><input type="checkbox" data-key="agree_4"> <span>æˆ‘çŸ¥é“è¡“å¾Œ24å°æ™‚å…§ï¼Œéœ€ä¿æŒç«æ¯›ä¹¾ç‡¥ï¼Œé¿å…å¤¾ç«æ¯›ã€æ‰çœ¼ç›ï¼Œä»¥ç¶­æŒç«æ¯›å¥åº·åº¦ã€æ²ç¿¹åº¦ã€‚</span></label>
                            <label class="agree-label"><input type="checkbox" data-key="agree_5"> <span>æˆ‘å·²é–±è®€ä¸¦äº†è§£ç¾ç«å¾Œä¿é¤Šæ–¹å¼ï¼ŒåŠç¶­è­·ç´°é …ï¼Œäº†è§£ç¾ç«å¾Œç«æ¯›ä¿è­·èˆ‡ç¶­è­·æ˜¯æˆ‘è‡ªå·±çš„è²¬ä»»ã€‚</span></label>
                            <p style="margin-top:20px;">é¡§å®¢ç°½åï¼š</p>
                            <div id="signature-preview-box" onclick="window.openSignatureModal()">
                                <img id="signature-preview-img" src="" alt="é»æ“Šç°½å" />
                                <span id="signature-placeholder">âœï¸ é»æ“Šæ­¤è™•é–‹å•Ÿç°½åæ¿</span>
                            </div>
                        </div></div>
                        <button type="button" class="btn-save" onclick="window.saveProfile()">ğŸ’¾ æ›´æ–°è³‡æ–™è‡³é›²ç«¯</button>
                    </div>
                </div>
                <div id="sessions" class="tab-content"><div style="text-align:right;margin-bottom:10px;"><button class="add-btn" onclick="window.openSessionModal()">+ æ–°å¢èª²ç¨‹</button></div><div id="sessionList" style="overflow-y:auto;flex-grow:1;"></div></div>
                <div id="billing" class="tab-content"><div style="text-align:right;margin-bottom:10px;"><button class="add-btn" onclick="window.jumpToPosWithClient()">+ æ–°å¢æ¶ˆè²» (å‰å¾€çµå¸³)</button></div><div style="overflow-y:auto;flex-grow:1;"><table><thead><tr><th>æ—¥æœŸ</th><th>é …ç›®</th><th>é‡‘é¡</th><th>æ“ä½œ</th></tr></thead><tbody id="billingList"></tbody></table></div></div>
                <div id="notes" class="tab-content"><h3>ğŸ“Œ æ¨™ç±¤</h3><div class="tags-container" id="tagList"><span class="tag-chip" data-tag="é»‘åå–®" onclick="window.toggleTag('é»‘åå–®')">âš ï¸ é»‘åå–®</span><span class="tag-chip" data-tag="VIP" onclick="window.toggleTag('VIP')">ğŸ‘‘ VIP</span><span class="tag-chip" data-tag="å®¹æ˜“é²åˆ°" onclick="window.toggleTag('å®¹æ˜“é²åˆ°')">â° å®¹æ˜“é²åˆ°</span><span class="tag-chip" data-tag="å–œæ­¡å®‰éœ" onclick="window.toggleTag('å–œæ­¡å®‰éœ')">ğŸ¤« å–œæ­¡å®‰éœ</span><span class="tag-chip" data-tag="å¥½èŠå¤©" onclick="window.toggleTag('å¥½èŠå¤©')">ğŸ’¬ å¥½èŠå¤©</span><span class="tag-chip" data-tag="è¿½æ±‚å®Œç¾" onclick="window.toggleTag('è¿½æ±‚å®Œç¾')">âœ¨ è¿½æ±‚å®Œç¾</span></div><div class="add-tag-wrapper"><input type="text" id="new_tag_input" placeholder="æ–°æ¨™ç±¤åç¨±" style="width:120px;"><button class="add-btn" style="margin:0; padding:5px 10px;" onclick="window.addNewCustomTag()">+ è‡ªè¨‚</button></div><h3>ğŸ“ å‚™è¨»</h3><textarea id="clientNotes" style="width:100%;height:200px;border:2px solid var(--main-pink);" oninput="window.debounceSaveProfile()"></textarea><button type="button" class="btn-save" onclick="window.saveProfile()">ğŸ’¾ æ›´æ–°å‚™è¨»</button></div>
            </div>
        </div>
    </div>

    <div id="sessionModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="window.closeModal('sessionModal')">&times;</span><h3>æ–°å¢èª²ç¨‹</h3><div class="form-row"><input type="datetime-local" id="sess_date"></div><div style="border:1px solid #ddd; padding:10px;"><label><input type="checkbox" id="sess_upper"> ä¸Šç«æ¯›</label><br><label><input type="checkbox" id="sess_lower"> ä¸‹ç«æ¯›</label><br><label><input type="checkbox" id="sess_brow"> é‡ç”Ÿçœ‰</label></div><button class="btn-save" onclick="window.saveSession()">å»ºç«‹</button></div></div>
    <div id="billingModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="window.closeModal('billingModal')">&times;</span><h3>æ–°å¢æ¶ˆè²»</h3><div class="form-row"><input type="text" id="bill_item" placeholder="é …ç›®"></div><div class="form-row"><input type="number" id="bill_amt" placeholder="é‡‘é¡"></div><button class="btn-save" onclick="window.saveTransaction()">ç¢ºèª</button></div></div>
    <div id="tintModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="window.closeModal('tintModal')">&times;</span><h3>æ¿ƒé»‘é¤Šè­· - è«‹é¸æ“‡</h3><div style="display:flex; gap:10px; justify-content:center;"><button class="item-btn" onclick="window.addTint('ä¸Šç«æ¯›', 200)">ä¸Šç«æ¯›<br>$200</button><button class="item-btn" onclick="window.addTint('ä¸‹ç«æ¯›', 100)">ä¸‹ç«æ¯›<br>$100</button></div></div></div>

    <div id="signatureModal" class="modal">
        <div class="modal-content" style="width: 90%; height: 80%; display:flex; flex-direction:column; padding:10px;">
            <h3 style="text-align:center; margin:5px 0;">é¡§å®¢ç°½å</h3>
            <div style="flex-grow: 1; border: 2px dashed var(--text-color); position: relative; background: #fff; border-radius:10px; overflow:hidden;">
                <canvas id="large-signature-pad" style="width: 100%; height: 100%; touch-action: none; display:block;"></canvas>
            </div>
            <div style="margin-top: 15px; display:flex; gap:20px; justify-content: center;">
                <button class="delete-btn" style="font-size:1.2rem; padding:10px 30px; border-radius:10px;" onclick="window.clearLargeSignature()">ğŸ”„ é‡æ–°ç°½å</button>
                <button class="btn-save" style="font-size:1.2rem; padding:10px 30px; margin:0; width:auto;" onclick="window.confirmSignature()">âœ… ç¢ºèªå­˜æª”</button>
                <button class="back-home-btn" style="font-size:1.2rem; padding:10px 30px;" onclick="window.closeModal('signatureModal')">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, where, getDocs, deleteDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”¥ é‡‘é‘°è¨­å®š ğŸ”¥
        const firebaseConfig = {
            apiKey: "AIzaSyDOmZLFPtI6v7BpyoLuMG38XWM1PYZaVZE",
            authDomain: "bianca-customer.firebaseapp.com",
            projectId: "bianca-customer",
            storageBucket: "bianca-customer.firebasestorage.app",
            messagingSenderId: "200747670160",
            appId: "1:200747670160:web:e1f03edddd2eb17ecad615",
            measurementId: "G-EB2Z7H77BT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- View Control ---
        const views = { login: 'login-overlay', dashboard: 'dashboard-view', pos: 'pos-view', crm: 'crm-view', daily: 'daily-view', monthly: 'monthly-view' };
        function showView(name) {
            Object.values(views).forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById(views[name]).style.display = (name === 'login' || name === 'dashboard') ? 'flex' : 'flex';
        }

        onAuthStateChanged(auth, (user) => {
            if (user) { showView('dashboard'); startListeningDB(); setInterval(updateClock, 1000); } else { showView('login'); }
        });

        window.startLogin = () => { signInWithEmailAndPassword(auth, document.getElementById('login_email').value, document.getElementById('login_pwd').value).catch(() => { document.getElementById('loginError').style.display='block'; document.getElementById('loginError').innerText="ç™»å…¥å¤±æ•—"; }); }
        document.getElementById('btnLogin').onclick = window.startLogin;
        document.getElementById('btnLogout').onclick = () => signOut(auth).then(()=>location.reload());

        window.goToDashboard = () => showView('dashboard');
        window.goToPOS = () => { showView('pos'); renderPOS(); renderClientDatalist(); };
        window.goToCRM = () => showView('crm');
        window.goToDaily = (targetDate) => { showView('daily'); renderDailyReport(targetDate); };
        window.goToMonthly = () => { showView('monthly'); document.getElementById('monthlyPicker').value=new Date().toISOString().slice(0,7); renderMonthlyReport(); };

        // --- Utilities ---
        function getLocalYMD() {
            const d = new Date();
            return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        }
        
        function isTodayBirthday(birthdayStr) {
            if (!birthdayStr) return false;
            const today = new Date();
            const [y, m, d] = birthdayStr.split('-');
            return (parseInt(m) === today.getMonth() + 1) && (parseInt(d) === today.getDate());
        }

        // V45: Sidebar Toggle
        window.toggleSidebar = () => {
            document.getElementById('crmSidebar').classList.toggle('closed');
        }

        // --- POS Logic ---
        let defaultMenu = {
            courses: [{ name: "ä¸Šç«æ¯›ç®¡ç†", price: 999 }, { name: "ä¸‹ç«æ¯›ç®¡ç†", price: 500 }, { name: "é‡ç”Ÿçœ‰é›•å¡‘", price: 999 }],
            products: [{ name: "ç«æ¯›é›¨è¡£", price: 600 }, { name: "ç«æ¯›æ»‹é¤Šæ¶²", price: 930 }],
            discounts: [
                { name: "9æŠ˜å„ªæƒ ", type: "discount", val: 0.9 }, 
                { name: "åˆ†äº«å„ªæƒ ", type: "fixed_discount", val: 50 }, 
                { name: "å›è¨ªå„ªæƒ ", type: "fixed_discount", val: 100 }
            ]
        };
        let menuData = JSON.parse(localStorage.getItem('posMenu')) || defaultMenu;
        let cart = [];
        let selectedPosClient = null;
        let clients = [];
        let currentClientId = null;
        let unsubscribeDaily = null;
        let unsubscribeMonthly = null;
        let saveTimer = null; 
        
        // V48: Signature Variables
        let signaturePad, signatureCtx, isSigning = false;
        // V49: Selected Item Variables
        let selectedCartIndex = -1;

        function startListeningDB() {
            onSnapshot(query(collection(db, "clients"), orderBy("id", "desc")), (snap) => {
                clients = snap.docs.map(d => ({ firebaseId: d.id, ...d.data() }));
                window.renderClientList();
                renderClientDatalist();
                if(window.pendingNewClientId) {
                    const newClient = clients.find(c => c.id === window.pendingNewClientId);
                    if(newClient) {
                        window.loadClient(newClient.id);
                        window.pendingNewClientId = null; 
                        setTimeout(() => document.getElementById('p_name').focus(), 100);
                    }
                } else if(currentClientId) {
                     window.loadClient(currentClientId);
                }
            });
        }

        function renderPOS() {
            renderSection('pos_courses', menuData.courses, 'èª²ç¨‹');
            renderSection('pos_products', menuData.products, 'ç”¢å“');
            renderSection('pos_discounts', menuData.discounts, 'å„ªæƒ ');
        }
        function renderSection(id, items, category) {
            const el = document.getElementById(id); el.innerHTML = '';
            items.forEach(item => {
                const btn = document.createElement('div'); btn.className = 'item-btn';
                if(item.type === 'discount') { 
                    btn.innerHTML = `<div style="font-weight:bold">${item.name}</div><small>å…¨å–®æŠ˜æ‰£</small>`; 
                    btn.onclick = () => addToCart({ name: item.name, price: 0, type: 'discount', val: item.val }); 
                } 
                else if(item.type === 'fixed_discount') { 
                    btn.innerHTML = `<div style="font-weight:bold">${item.name}</div><small>-$${item.val}</small>`; 
                    btn.onclick = () => addToCart({ name: item.name, price: -item.val, type: 'fixed_discount', val: item.val }); 
                }
                else { 
                    btn.innerHTML = `<div style="font-weight:bold">${item.name}</div><div>$${item.price}</div>`; 
                    btn.onclick = () => addToCart({ name: item.name, price: item.price, category: category }); 
                }
                el.appendChild(btn);
            });
        }

        function renderClientDatalist() {
            const dl = document.getElementById('client_list_suggestions'); dl.innerHTML = '';
            clients.forEach(c => { const opt = document.createElement('option'); opt.value = c.name; dl.appendChild(opt); });
        }

        window.checkPosClient = (val) => {
            selectedPosClient = clients.find(c => c.name === val) || null;
            document.getElementById('posBalance').innerText = selectedPosClient ? `$${selectedPosClient.balance||0}` : '$0';
            updateCalculations(); 
        }

        window.addExpense = (type) => {
            let amt = prompt(`è«‹è¼¸å…¥[${type}]é‡‘é¡ï¼š`);
            if(!amt || isNaN(amt)) return;
            let note = prompt(`è«‹è¼¸å…¥[${type}]å‚™è¨» (å¯é¸)ï¼š`, "");
            let finalName = type;
            if(note) finalName += ` (${note})`;
            addToCart({ name: finalName, price: -Math.abs(parseInt(amt)), category: 'æ”¯å‡º', type: 'expense' });
        }

        window.addModelPrice = () => {
            let amt = prompt("è«‹è¼¸å…¥æ¨¡ç‰¹åƒ¹é‡‘é¡ï¼š");
            if(!amt || isNaN(amt) || parseInt(amt) < 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");
            let note = prompt("è«‹è¼¸å…¥å‚™è¨» (ä¾‹å¦‚: é …ç›®åç¨±)ï¼š", "");
            let finalName = "æ¨¡ç‰¹åƒ¹";
            if(note) finalName += `-${note}`;
            addToCart({ name: finalName, price: parseInt(amt), category: 'èª²ç¨‹' });
        }

        window.showTintModal = () => document.getElementById('tintModal').style.display='flex';
        window.addTint = (type, price) => { addToCart({ name: `æ¿ƒé»‘é¤Šè­·-${type}`, price: price, category: 'èª²ç¨‹' }); window.closeModal('tintModal'); }
        window.addTopUp = () => { let amt=prompt("è«‹è¼¸å…¥å„²å€¼é‡‘é¡ï¼š"); if(amt&&!isNaN(amt)) addToCart({ name:"å„²å€¼é‡‘", price:parseInt(amt), type:'topup_purchase', category: 'å„²å€¼é‡‘' }); }

        function addToCart(item) {
            if(item.type === 'discount' && cart.some(i => i.type === 'discount')) return alert("å·²æœ‰æŠ˜æ‰£");
            
            // Store original price if not present
            if(item.price && !item.originalPrice) item.originalPrice = item.price;
            
            cart.push(item);
            selectedCartIndex = cart.length - 1; // Auto select new item
            updateCalculations();
        }
        
        // V49: Select Item
        window.selectCartItem = (idx) => {
            selectedCartIndex = idx;
            updateCalculations(); // Re-render to show highlight
        }

        // V49: Apply Single Item Discount
        window.applySingleItemDiscount = () => {
            if(selectedCartIndex === -1 || !cart[selectedCartIndex]) return alert("è«‹å…ˆå¾å³å´é»é¸è¦æ‰“æŠ˜çš„å•†å“ï¼");
            
            const item = cart[selectedCartIndex];
            if(item.type === 'discount' || item.type === 'fixed_discount') return alert("å„ªæƒ é …ç›®ç„¡æ³•å†æ‰“æŠ˜");
            
            let rate = prompt(`è«‹è¼¸å…¥ [${item.name}] çš„æŠ˜æ‰£ (ä¾‹å¦‚ 0.9 = 9æŠ˜):`);
            if(!rate || isNaN(rate)) return;
            
            // Reset to original price before calculating new discount to avoid double counting
            const basePrice = item.originalPrice || item.price;
            item.price = Math.round(basePrice * parseFloat(rate));
            
            // Update name to show discount if not already shown
            if(!item.name.includes("æŠ˜)")) {
                item.name = `${item.name} (${parseFloat(rate)*10}æŠ˜)`;
            } else {
                // Replace existing discount text
                item.name = item.name.replace(/\(\d+(\.\d+)?æŠ˜\)/, `(${parseFloat(rate)*10}æŠ˜)`);
            }
            
            // Item is now discounted, mark it so we don't accidentally auto-discount it later if needed (though auto discount checks specific names)
            // But user manually modified it, so we leave it be.
            
            updateCalculations();
        }

        function applyAutoDiscounts() {
            if(!selectedPosClient) return;
            const hasUpper = hasHistory(selectedPosClient, "ä¸Šç«æ¯›");
            const hasBrow = hasHistory(selectedPosClient, "é‡ç”Ÿçœ‰");

            const counts = { upper:0, lower:0, brow:0, tintUp:0, tintLow:0 };

            cart.forEach(item => {
                item.appliedAuto = null; 
                if(item.name.includes("æ¨¡ç‰¹åƒ¹")) return;

                if(item.name.includes("ä¸Šç«æ¯›ç®¡ç†") && !hasUpper) { item.price = 699; item.appliedAuto = "é¦–æ¬¡é«”é©—å„ªæƒ "; }
                if(item.name === "é‡ç”Ÿçœ‰é›•å¡‘" && !hasBrow) { item.price = 699; item.appliedAuto = "é¦–æ¬¡é«”é©—å„ªæƒ "; }

                if(item.name.includes("ä¸Šç«æ¯›ç®¡ç†")) counts.upper++;
                if(item.name.includes("ä¸‹ç«æ¯›ç®¡ç†")) counts.lower++;
                if(item.name.includes("é‡ç”Ÿçœ‰")) counts.brow++;
                if(item.name.includes("æ¿ƒé»‘é¤Šè­·-ä¸Šç«æ¯›")) counts.tintUp++;
                if(item.name.includes("æ¿ƒé»‘é¤Šè­·-ä¸‹ç«æ¯›")) counts.tintLow++; 
            });

            cart = cart.filter(i => i.type !== 'auto_discount');
            if(counts.upper > 0 && counts.lower > 0) cart.push({ name: "åŠ è³¼ä¸‹ç«æ¯›å„ªæƒ ", price: -200, type: 'auto_discount' });
            if((counts.upper > 0 || counts.lower > 0) && counts.brow > 0) cart.push({ name: "è€€çœ¼çµ„åˆå„ªæƒ ", price: -100, type: 'auto_discount' });
            if(counts.tintUp > 0 && counts.tintLow > 0) cart.push({ name: "å­˜åœ¨æ„ŸUpå„ªæƒ ", price: -50, type: 'auto_discount' });
        }

        function hasHistory(client, keyword) {
            if(!client.transactions) return false;
            return client.transactions.some(t => {
                const hasKeyword = t.item && t.item.includes(keyword);
                const isModel = t.item && t.item.includes("æ¨¡ç‰¹åƒ¹");
                return hasKeyword && !isModel;
            });
        }

        window.updateCalculations = () => {
            if(selectedPosClient) applyAutoDiscounts(); 
            const list = document.getElementById('cartList'); list.innerHTML = '';
            
            let grossTotal = 0;
            let fixedDeductions = 0;
            let discountMultiplier = 1;

            cart.forEach(i => {
                if(i.type === 'discount') {
                    discountMultiplier = i.val;
                } else if(i.type === 'fixed_discount') {
                    fixedDeductions += i.val;
                } else {
                    grossTotal += i.price;
                }
            });

            let taxableBase = grossTotal - fixedDeductions;
            let grandTotal = Math.round(taxableBase * discountMultiplier);
            
            document.getElementById('posTotal').innerText = `$${grandTotal}`;

            cart.forEach((item, idx) => {
                let priceDisplay = `$${item.price}`;
                if(item.type==='discount') priceDisplay = `<span style="color:red">-${Math.round(taxableBase * (1-discountMultiplier))}</span>`;
                else if(item.type==='fixed_discount') priceDisplay = `<span style="color:red">-$${item.val}</span>`;
                else if(item.price < 0) priceDisplay = `<span style="color:var(--danger-color)">$${item.price}</span>`;
                
                let tag = item.appliedAuto ? `<span class="first-time-badge">${item.appliedAuto}</span>` : '';
                let removeBtn = item.type !== 'auto_discount' ? `<span class="cart-remove" onclick="window.removeCart(${idx})">Ã—</span>` : ''; 
                
                // V49: Add selection class and click handler
                let activeClass = (idx === selectedCartIndex) ? 'active-item' : '';
                
                list.innerHTML += `<div class="cart-item ${activeClass}" onclick="window.selectCartItem(${idx})"><div>${item.name} ${tag}</div><span>${priceDisplay} ${removeBtn}</span></div>`;
            });

            if(cart.length===0) list.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:50px;">å°šæœªé¸æ“‡é …ç›®</div>';

            const useBal = document.getElementById('use_balance').checked;
            const balance = selectedPosClient ? (selectedPosClient.balance || 0) : 0;
            let deduct = 0;
            if(useBal && grandTotal > 0) { 
                 deduct = Math.min(grandTotal, balance);
            }
            let remain = grandTotal - deduct;
            
            document.getElementById('deduct_display').innerText = `-$${deduct}`;
            document.getElementById('remain_display').innerText = `$${remain}`;
            
            const payRow = document.getElementById('final_pay_method_row');
            payRow.style.display = 'flex'; 
        }

        window.removeCart = (idx) => { 
            cart.splice(idx, 1); 
            if(selectedCartIndex === idx) selectedCartIndex = -1; // Reset selection if removed
            window.updateCalculations(); 
        };
        
        window.submitCheckout = () => {
            if(cart.length===0) return alert("è³¼ç‰©è»Šç©ºçš„");
            const name = document.getElementById('pos_client_name').value || "Walk-in";
            
            // Re-calc for submit
            let grossTotal = 0, fixedDeductions = 0, discountMultiplier = 1, topupAmt = 0;
            let courseItems = [];
            let catSummary = {};

            cart.forEach(i => {
                if(i.type==='discount') discountMultiplier = i.val;
                else if(i.type==='fixed_discount') fixedDeductions += i.val;
                else {
                    grossTotal += i.price;
                    if(i.type==='topup_purchase') topupAmt += i.price;
                    
                    let cat = i.category || 'å…¶ä»–';
                    if(!catSummary[cat]) catSummary[cat] = 0;
                    catSummary[cat] += i.price;

                    if(!i.type && !i.name.includes("é›¨è¡£") && !i.name.includes("æ»‹é¤Šæ¶²") && !i.name.includes("å„²å€¼") && !i.category?.includes('æ”¯å‡º')) {
                        courseItems.push(i.name);
                    }
                }
            });
            let taxableBase = grossTotal - fixedDeductions;
            let grandTotal = Math.round(taxableBase * discountMultiplier);
            
            let categoryStr = Object.entries(catSummary).map(([k,v]) => `${k}($${v})`).join(" + ");

            const useBal = document.getElementById('use_balance').checked;
            const balance = selectedPosClient ? (selectedPosClient.balance || 0) : 0;
            let deduct = 0;
            if(useBal && grandTotal > 0) deduct = Math.min(grandTotal, balance);
            let remain = grandTotal - deduct;
            
            const payMethod = remain > 0 ? document.getElementById('pos_method').value : (grandTotal < 0 ? "ç¾é‡‘æ”¯å‡º" : "å„²å€¼é‡‘å…¨é¡");
            const itemsName = cart.map(i => i.name).join("+");

            if(topupAmt > 0 && useBal) return alert("è³¼è²·å„²å€¼é‡‘æ™‚ä¸å¯ä½¿ç”¨é¤˜é¡æ‰£æ¬¾ï¼");

            const localDate = getLocalYMD(); 
            
            addDoc(collection(db, "pos_records"), {
                date: localDate, 
                timestamp: Date.now(), 
                client: name, 
                items: itemsName, 
                category: categoryStr, 
                total: grandTotal,
                method: useBal ? `å„²å€¼$${deduct} + ${payMethod}$${remain}` : payMethod,
                type: topupAmt > 0 ? 'topup' : 'service'
            }).then(() => {
                if(selectedPosClient) {
                    let newBal = balance - deduct + topupAmt;
                    const newTrans = {
                        date: localDate, 
                        item: itemsName, 
                        amt: grandTotal,
                        method: useBal ? `å„²å€¼æ‰£$${deduct}/${payMethod}` : payMethod
                    };
                    
                    let updates = {
                        balance: newBal,
                        transactions: arrayUnion(newTrans)
                    };

                    if(courseItems.length > 0) {
                        const newSession = {
                            date: localDate,
                            items: courseItems,
                            prePhotos: [], padPhotos: [], postPhotos: []
                        };
                        updates.sessions = arrayUnion(newSession);
                    }

                    updateDoc(doc(db, "clients", selectedPosClient.firebaseId), updates);
                    alert(`çµå¸³å®Œæˆï¼\nè³‡æ–™å·²åŒæ­¥è‡³å®¢æˆ¶ç®¡ç† (æ¶ˆè²»/èª²ç¨‹)ã€‚\né¤˜é¡æ›´æ–°ç‚ºï¼š$${newBal}`);
                } else {
                    alert(`çµå¸³å®Œæˆï¼$${grandTotal} (å·²å¯«å…¥å¸³å‹™)`);
                }
                cart=[]; document.getElementById('pos_client_name').value=''; 
                document.getElementById('posBalance').innerText='-';
                document.getElementById('use_balance').checked=false;
                selectedPosClient = null;
                selectedCartIndex = -1; // V49: Reset selection
                window.updateCalculations();
            });
        }

        function getROCDate(d) {
            const date = d ? new Date(d) : new Date();
            return `${date.getFullYear()-1911}/${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')}`;
        }
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
            if(document.getElementById('receiptTime')) document.getElementById('receiptTime').innerText = `${getROCDate()} ${timeStr}`;
        }

        window.renderDailyReport = (specificDate) => {
            if(unsubscribeDaily) unsubscribeDaily(); 
            
            const dateToQuery = specificDate || getLocalYMD(); 
            
            const displayDate = new Date(dateToQuery);
            document.getElementById('dailyDate').innerText = `${displayDate.getFullYear()-1911}/${String(displayDate.getMonth()+1).padStart(2,'0')}/${String(displayDate.getDate()).padStart(2,'0')}`;
            
            const lockQuery = query(collection(db, "daily_closings"), where("date", "==", dateToQuery));
            getDocs(lockQuery).then(snap => {
                const isLocked = !snap.empty;
                document.getElementById('lockMsg').style.display = isLocked ? 'inline' : 'none';
                document.getElementById('closeDayBtn').style.display = isLocked ? 'none' : 'inline-block';
                
                const q = query(collection(db, "pos_records"), where("date", "==", dateToQuery));
                
                unsubscribeDaily = onSnapshot(q, (snapshot) => {
                    const tbody = document.getElementById('dailyList'); tbody.innerHTML = '';
                    let total = 0;
                    
                    let records = [];
                    snapshot.forEach(doc => records.push({id: doc.id, ...doc.data()}));
                    records.sort((a,b) => b.timestamp - a.timestamp);
                    
                    records.forEach(d => {
                        total += d.total;
                        const time = new Date(d.timestamp).toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
                        const displayItem = d.category || d.items; 
                        const delBtn = `<button class="delete-btn" onclick="window.deleteDailyRecord('${d.id}')">ğŸ—‘ï¸</button>`;
                        const amtStyle = d.total < 0 ? 'color:var(--danger-color);font-weight:bold' : '';
                        tbody.innerHTML += `<tr><td>${time}</td><td>${d.client}</td><td>${displayItem}</td><td style="${amtStyle}">$${d.total}</td><td>${d.method}</td><td>${delBtn}</td></tr>`;
                    });
                    document.getElementById('dailyTotal').innerText = `$${total}`;
                });
            });
        }
        
        window.deleteDailyRecord = (id) => {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†çµå¸³ï¼Ÿ(ç³»çµ±å°‡åŒæ­¥åˆªé™¤å®¢æˆ¶æ¶ˆè²»/èª²ç¨‹ç´€éŒ„ä¸¦é‚„åŸé¤˜é¡)")) return;
            
            getDocs(query(collection(db, "pos_records"), where("__name__", "==", id))).then(snap => {
                if(!snap.empty) {
                    const target = snap.docs[0].data();
                    
                    const client = clients.find(c => c.name === target.client);
                    if(client) {
                        let newBal = client.balance || 0;
                        let isModified = false;
                        
                        if(target.method.includes("å„²å€¼æ‰£")) {
                            const match = target.method.match(/å„²å€¼æ‰£\$(\d+)/);
                            if(match) { newBal += parseInt(match[1]); isModified = true; }
                        }
                        // Handle Expense/Topup
                        if(target.total < 0 && target.category.includes("æ”¯å‡º")) {
                        }
                        if(target.items.includes("å„²å€¼é‡‘") && target.total > 0) { 
                             newBal -= target.total; isModified = true;
                        }

                        let newTrans = client.transactions ? [...client.transactions] : [];
                        const transIdx = newTrans.findIndex(t => t.date === target.date && t.item === target.items && t.amt === target.total);
                        if(transIdx > -1) { newTrans.splice(transIdx, 1); isModified = true; }
                        
                        let newSessions = client.sessions ? [...client.sessions] : [];
                        const sessIdx = newSessions.findIndex(s => s.date.startsWith(target.date) && target.items.includes(s.items[0])); 
                        if(sessIdx > -1) { newSessions.splice(sessIdx, 1); isModified = true; }
                        
                        if(isModified) {
                            updateDoc(doc(db, "clients", client.firebaseId), { 
                                balance: newBal, 
                                transactions: newTrans, 
                                sessions: newSessions 
                            });
                        }
                    }
                    deleteDoc(doc(db, "pos_records", id));
                }
            });
        }

        window.confirmDailyClose = () => {
            const total = document.getElementById('dailyTotal').innerText;
            if(confirm(`ç¢ºèªåŸ·è¡Œæœ¬æ—¥çµå¸³ï¼Ÿç¸½é‡‘é¡ ${total}\n(æ³¨æ„ï¼šçµå¸³å¾Œå°‡ç„¡æ³•åˆªé™¤ä»Šæ—¥ç´€éŒ„)`)) {
                const today = getLocalYMD();
                const amt = parseInt(total.replace('$',''));
                addDoc(collection(db, "daily_closings"), { date: today, total: amt, status: 'closed' });
                alert("å·²å®Œæˆæ—¥çµå­˜æª”ï¼");
                window.renderDailyReport(); 
            }
        }

        window.renderMonthlyReport = () => {
            if(unsubscribeMonthly) unsubscribeMonthly();
            const picker = document.getElementById('monthlyPicker').value;
            const start = picker + "-01";
            const end = picker + "-31";

            const q = query(collection(db, "pos_records"), where("date", ">=", start), where("date", "<=", end));
            
            unsubscribeMonthly = onSnapshot(q, (snap) => {
                const tbody = document.getElementById('monthlyList'); tbody.innerHTML = '';
                const dailyData = {};
                let monthTotal = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    if(!dailyData[d.date]) dailyData[d.date] = { total: 0, count: 0 };
                    dailyData[d.date].total += d.total;
                    dailyData[d.date].count += 1;
                    monthTotal += d.total;
                });

                Object.keys(dailyData).sort().forEach(date => {
                    tbody.innerHTML += `<tr onclick="window.goToDaily('${date}')" style="cursor:pointer" title="é»æ“ŠæŸ¥çœ‹ç•¶æ—¥æ˜ç´°"><td>${date}</td><td>${dailyData[date].count}å–®</td><td>$${dailyData[date].total}</td><td>-</td></tr>`;
                });
                document.getElementById('monthlyTotal').innerText = `$${monthTotal}`;
            });
        }

        window.renderClientList=()=>{
            const l=document.getElementById('clientList');
            const f=document.getElementById('monthFilter').value;
            l.innerHTML='';
            clients.forEach(c=>{
                let s=true;
                if(f!=='all'){if(!c.birthday)s=false;else if(c.birthday.split('-')[1]!==f)s=false;}
                if(s){
                    const li=document.createElement('li');
                    li.className=`client-item ${c.id===currentClientId?'active':''}`;
                    let birthdayIcon = '';
                    if (isTodayBirthday(c.birthday)) {
                        birthdayIcon = ' ğŸ‚';
                    }
                    li.innerHTML=`<span>${c.name}${birthdayIcon}</span><small>$${c.balance||0}</small>`;
                    li.addEventListener('click', () => {
                        window.loadClient(c.id);
                        document.querySelectorAll('.client-item').forEach(i=>i.classList.remove('active'));
                        li.classList.add('active');
                    });
                    l.appendChild(li);
                }
            })
        };
        
        window.loadClient=(id)=>{
            if(saveTimer) clearTimeout(saveTimer);
            currentClientId=id;
            const c=clients.find(x=>x.id===id);
            document.getElementById('mainContainer').style.visibility='visible';
            
            document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
            
            document.getElementById('p_name').value=c.name||'';
            document.getElementById('p_phone').value=c.phone||'';
            document.getElementById('p_birthday').value=c.birthday||'';
            document.getElementById('p_region').value=c.region||''; 
            document.getElementById('clientNotes').value=c.notes||'';
            
            if(c.profileData) {
                for (const [key, val] of Object.entries(c.profileData)) {
                    const el = document.querySelector(`input[data-key="${key}"]`);
                    if(el) el.checked = val;
                }
            }
            if(c.friend_name) document.getElementById('p_friend_name').value = c.friend_name;
            if(c.neighbor_unit) document.getElementById('p_neighbor_unit').value = c.neighbor_unit;
            if(c.eye_disease) document.getElementById('p_disease').value = c.eye_disease;
            if(c.allergy_other) document.getElementById('p_allergy_other').value = c.allergy_other;
            if(c.experience) document.getElementById('p_exp').value = c.experience;
            if(c.habit) document.getElementById('p_habit').value = c.habit;
            
            attachAutoSave();

            // V48: Preview Logic
            const previewImg = document.getElementById('signature-preview-img');
            const placeholder = document.getElementById('signature-placeholder');
            
            if(c.signature) {
                previewImg.src = c.signature;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
            }

            const sL=document.getElementById('sessionList');sL.innerHTML='';
            if(c.sessions)c.sessions.forEach((s,i)=>{
                let h=`<div style="background:#FFF0F5;border:1px solid #EAC8D0;margin-bottom:10px;padding:10px;border-radius:10px;"><div style="display:flex;justify-content:space-between;"><div><b>${s.date}</b><br>${s.items.join(', ')}</div><button style="background:var(--danger-color);color:white;border:none;padding:2px 8px;border-radius:5px;cursor:pointer;" onclick="window.deleteSession(${i})">ğŸ—‘ï¸</button></div><div class="photos-container">${renderPG(i,'prePhotos',s.prePhotos||[],'å‰')}${renderPG(i,'padPhotos',s.padPhotos||[],'å¢Šç‰‡')}${renderPG(i,'postPhotos',s.postPhotos||[],'å¾Œ')}</div></div>`;
                sL.innerHTML+=h;
            });
            
            const bL=document.getElementById('billingList');bL.innerHTML='';
            if(c.transactions)c.transactions.forEach((t, i)=>{
                bL.innerHTML+=`<tr><td>${t.date}</td><td>${t.item}</td><td>$${t.amt}</td><td><button class="delete-btn" onclick="window.deleteTransaction(${i})">ğŸ—‘ï¸</button></td></tr>`;
            });
            renderTags();
        };
        
        // V48: Open Large Modal Logic
        window.openSignatureModal = () => {
            if(!currentClientId) return alert("è«‹å…ˆé¸æ“‡å®¢æˆ¶ï¼");
            
            const modal = document.getElementById('signatureModal');
            modal.style.display = 'flex';
            
            // Wait for modal to render, then resize canvas
            setTimeout(() => {
                signaturePad = document.getElementById('large-signature-pad');
                signatureCtx = signaturePad.getContext('2d');
                signaturePad.width = signaturePad.offsetWidth;
                signaturePad.height = signaturePad.offsetHeight;
                
                // Style
                signatureCtx.strokeStyle = "#000";
                signatureCtx.lineWidth = 3;
                signatureCtx.lineCap = "round";
                
                // Events
                signaturePad.onmousedown = startSign;
                signaturePad.onmousemove = moveSign;
                signaturePad.onmouseup = endSign;
                signaturePad.onmouseout = endSign;
                signaturePad.ontouchstart = startSign;
                signaturePad.ontouchmove = moveSign;
                signaturePad.ontouchend = endSign;
            }, 100);
        }

        const startSign = (e) => {
            isSigning = true;
            signatureCtx.beginPath();
            const rect = signaturePad.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            signatureCtx.moveTo(x, y);
        }
        
        const moveSign = (e) => {
            if(!isSigning) return;
            e.preventDefault();
            const rect = signaturePad.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            signatureCtx.lineTo(x, y);
            signatureCtx.stroke();
        }
        
        const endSign = () => {
            isSigning = false;
        }

        // V48: Confirm & Save
        window.confirmSignature = () => {
            const dataUrl = signaturePad.toDataURL();
            const c = clients.find(x => x.id === currentClientId);
            
            updateDoc(doc(db, "clients", c.firebaseId), {
                signature: dataUrl
            }).then(() => {
                // Update Preview immediately
                const previewImg = document.getElementById('signature-preview-img');
                const placeholder = document.getElementById('signature-placeholder');
                previewImg.src = dataUrl;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
                
                window.closeModal('signatureModal');
            });
        }
        
        window.clearLargeSignature = () => {
            signatureCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
        }

        function attachAutoSave() {
            const inputs = document.querySelectorAll('#profile input, #profile textarea, #profile select');
            inputs.forEach(el => {
                el.oninput = window.debounceSaveProfile;
                el.onchange = window.debounceSaveProfile;
            });
        }
        
        // V47: Clears old small canvas logic references if any remain (Safety)
        window.clearSignature = () => {} 
        
        function renderPG(i,k,p,l){let h=`<div class="photo-column"><div style="text-align:center;font-size:0.8rem;color:#C79AA5;">${l}</div><div class="photo-grid">`;p.forEach(u=>h+=`<div class="photo-box has-img" style="background-image:url(${u})"></div>`);if(p.length<3)h+=`<label class="photo-box">+<input type="file" style="display:none" accept="image/*" onchange="window.uploadPhoto(${i},'${k}',this)"></label>`;return h+'</div></div>';}
        window.uploadPhoto=(i,k,inp)=>{if(inp.files[0]){const r=new FileReader();r.onload=e=>{const c=clients.find(x=>x.id===currentClientId);let ns=[...c.sessions];if(!ns[i][k])ns[i][k]=[];ns[i][k].push(e.target.result);updateDoc(doc(db,"clients",c.firebaseId),{sessions:ns});};r.readAsDataURL(inp.files[0]);}};
        window.createNewClient=()=>{const n=prompt("å§“å?");if(n)addDoc(collection(db,"clients"),{id:Date.now(),name:n,balance:0,birthday:"",sessions:[],transactions:[],notes:"",tags:[], profileData:{}, signature: ""}).then(()=>{window.pendingNewClientId = Date.now();});};
        
        window.saveProfile=()=>{
            if(!currentClientId) return;
            const c=clients.find(x=>x.id===currentClientId);
            if(c) {
                const profileData = {};
                document.querySelectorAll('input[type="checkbox"][data-key]').forEach(el => {
                    profileData[el.dataset.key] = el.checked;
                });
                
                updateDoc(doc(db,"clients",c.firebaseId),{
                    name:document.getElementById('p_name').value,
                    phone:document.getElementById('p_phone').value,
                    birthday:document.getElementById('p_birthday').value,
                    region: document.getElementById('p_region').value, 
                    notes:document.getElementById('clientNotes').value,
                    friend_name: document.getElementById('p_friend_name').value,
                    neighbor_unit: document.getElementById('p_neighbor_unit').value,
                    eye_disease: document.getElementById('p_disease').value,
                    allergy_other: document.getElementById('p_allergy_other').value,
                    experience: document.getElementById('p_exp').value,
                    habit: document.getElementById('p_habit').value,
                    profileData: profileData
                });
            }
        };
        
        window.debounceSaveProfile=()=>{
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer=setTimeout(window.saveProfile,1500); 
        };

        window.saveSession=()=>{const c=clients.find(x=>x.id===currentClientId);const d=document.getElementById('sess_date').value.replace('T',' ');let i=[];if(document.getElementById('sess_upper').checked)i.push("ä¸Šç«æ¯›");if(document.getElementById('sess_lower').checked)i.push("ä¸‹ç«æ¯›");if(document.getElementById('sess_brow').checked)i.push("é‡ç”Ÿçœ‰");const ns={date:d,items:i,prePhotos:[],padPhotos:[],postPhotos:[]};updateDoc(doc(db,"clients",c.firebaseId),{sessions:[ns,...(c.sessions||[])]}).then(()=>window.closeModal('sessionModal'));};
        
        window.deleteSession = (idx) => {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹ç´€éŒ„å—ï¼Ÿ(ç…§ç‰‡ä¹Ÿæœƒä¸€ä½µåˆªé™¤)")) {
                const c = clients.find(x => x.id === currentClientId);
                let newSessions = [...c.sessions];
                newSessions.splice(idx, 1);
                updateDoc(doc(db, "clients", c.firebaseId), { sessions: newSessions });
            }
        }

        window.deleteTransaction = async (idx) => {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿå°‡è¦–ç‚ºé€€è²»ï¼Œä¸¦åŒæ­¥åˆªé™¤æ—¥çµå¸³å‹™ã€‚")) return;

            const c = clients.find(x => x.id === currentClientId);
            let newTrans = [...c.transactions];
            const target = newTrans[idx];
            let newBal = c.balance || 0;
            let isModified = false;

            if(target.method.includes("å„²å€¼æ‰£")) { const match = target.method.match(/å„²å€¼æ‰£\$(\d+)/); if(match) { newBal += parseInt(match[1]); isModified = true; } }
            if(target.item && target.item.includes("å„²å€¼é‡‘")) { newBal -= target.amt; isModified = true; }
            
            newTrans.splice(idx, 1);
            let updateData = { transactions: newTrans };
            if(isModified) updateData.balance = newBal;
            
            let newSessions = c.sessions ? [...c.sessions] : [];
            const sessIdx = newSessions.findIndex(s => s.date.startsWith(target.date) && s.items.join("+") === target.item);
            if (sessIdx > -1) { newSessions.splice(sessIdx, 1); updateData.sessions = newSessions; }

            await updateDoc(doc(db, "clients", c.firebaseId), updateData);

            const q = query(collection(db, "pos_records"), 
                where("date", "==", target.date), 
                where("client", "==", c.name), 
                where("total", "==", target.amt)
            );
            const snap = await getDocs(q);
            snap.forEach(d => deleteDoc(doc(db, "pos_records", d.id)));
        }

        window.jumpToPosWithClient = () => {
            const c = clients.find(x=>x.id===currentClientId);
            if(!c) return;
            window.goToPOS();
            document.getElementById('pos_client_name').value = c.name;
            window.checkPosClient(c.name);
        }

        window.toggleTag=(t)=>{const c=clients.find(x=>x.id===currentClientId);let ts=c.tags?[...c.tags]:[];const i=ts.indexOf(t);if(i>-1)ts.splice(i,1);else ts.push(t);updateDoc(doc(db,"clients",c.firebaseId),{tags:ts});};
        window.addNewCustomTag=()=>{ const val=document.getElementById('new_tag_input').value; if(val){ window.toggleTag(val); document.getElementById('new_tag_input').value=''; } }
        
        function renderTags(){
            const c=clients.find(x=>x.id===currentClientId);
            document.querySelectorAll('.tag-chip').forEach(e=>{const t=e.getAttribute('data-tag');if(c.tags&&c.tags.includes(t))e.classList.add('active');else e.classList.remove('active');});
            const container = document.getElementById('tagList');
            document.querySelectorAll('.custom-chip').forEach(e => e.remove());
            if(c.tags) { c.tags.forEach(t => { if(!document.querySelector(`.tag-chip[data-tag="${t}"]`)) {
                const s=document.createElement('span'); s.className='tag-chip active custom-chip'; s.innerText=t; s.onclick=()=>window.toggleTag(t); container.appendChild(s);
            }})}
        }

        window.switchTab=(id,e)=>{document.querySelectorAll('.tab-content').forEach(d=>d.style.display='none');document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById(id).style.display='flex';e.target.classList.add('active');};
        window.openSessionModal=()=>document.getElementById('sessionModal').style.display='flex';
        window.openBillingModal=()=>document.getElementById('billingModal').style.display='flex';
        window.closeModal=(id)=>document.getElementById(id).style.display='none';
        
        window.onload = () => { 
            document.getElementById('sess_date').value = new Date().toISOString().slice(0,16); 
        }

    </script>
</body>
</html>